<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kazakhstan Helperï½œå“ˆè¨å…‹æ–¯å¦æ—…è¡Œç”Ÿæ´»åŠ©æ‰‹</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b1020; color: #e8ecff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .brand { font-weight: 700; letter-spacing: .2px; }
    .pill { font-size: 12px; opacity:.9; padding:6px 10px; border: 1px solid rgba(255,255,255,.15); border-radius: 999px; }
    .grid { display:grid; grid-template-columns: 1.3fr .7fr; gap: 12px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 18px; padding: 14px; box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

    select, input, button, textarea {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: #e8ecff;
      padding: 10px 12px;
    }

    /* è¾“å…¥æ¡†æ›´æ¸…æ™° */
    textarea {
      width: 100%;
      min-height: 92px;
      resize: vertical;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.06);
    }

    button { cursor:pointer; }
    button.primary { background: rgba(110,168,255,.25); border-color: rgba(110,168,255,.45); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .chat {
      height: 420px;
      overflow:auto;
      padding: 8px;
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
    }
    .msg { margin: 10px 0; padding: 10px 12px; border-radius: 14px; line-height: 1.45; white-space: pre-wrap; }
    .me { background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); }
    .bot { background: rgba(110,168,255,.12); border: 1px solid rgba(110,168,255,.25); }
    .meta { font-size: 12px; opacity: .8; margin-bottom: 6px; display:flex; gap:8px; align-items:center; justify-content:space-between;}
    .toolgrid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .tool { text-align:left; }
    .soon { opacity:.75; }
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px 12px;
      border-radius: 12px;
      display:none;
      max-width: 92vw;
    }
    a { color: #b8d1ff; }

    /* ===== Dropdown ç¾åŒ–ï¼ˆæš—è‰²ä¸»é¢˜ï¼‰ ===== */
    select {
      background: #1f2937 !important;
      color: #f9fafb !important;
      border: 1px solid #374151 !important;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      cursor: pointer;
    }
    select:hover { border-color: #60a5fa !important; }
    select option { background: #111827 !important; color: #f9fafb !important; }
    select option:checked { background: #2563eb !important; color: white !important; }

    /* å°çŠ¶æ€æ¡ */
    .statusbar{
      font-size:12px;
      opacity:.85;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin: 6px 0 0;
    }
    .badge{
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-size:12px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">Kazakhstan Helperï½œå“ˆè¨å…‹æ–¯å¦æ—…è¡Œç”Ÿæ´»åŠ©æ‰‹</div>
        <div style="opacity:.8;font-size:12px;margin-top:2px;">ä¸­ / ä¿„ / å“ˆï¼šç¿»è¯‘ + åœºæ™¯æ²Ÿé€š + ä¸€é”®æœ—è¯»ï¼ˆMVPï¼‰</div>
        <div class="statusbar">
          <div>æç¤ºï¼šå›½å¤–ä¼˜å…ˆ Groqï¼›å¦‚æœå¤±è´¥/è¶…æ—¶ä¼šè‡ªåŠ¨åˆ‡åˆ° DeepSeekã€‚</div>
          <div class="badge" id="engineBadge">å¼•æ“ï¼šAUTO</div>
        </div>
      </div>
      <div class="pill">V1 Â· åŒå¼•æ“è‡ªåŠ¨åˆ‡æ¢</div>
    </div>

    <div class="grid">
      <!-- Chat -->
      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:10px;">
          <div class="row">
            <label style="font-size:12px;opacity:.85;">è¾“å‡ºè¯­è¨€</label>
            <select id="lang">
              <option value="kk">å“ˆè¯­ï¼ˆKazakhï¼‰</option>
              <option value="ru">ä¿„è¯­ï¼ˆRussianï¼‰</option>
              <option value="zh">ä¸­æ–‡ï¼ˆChineseï¼‰</option>
            </select>

            <label style="font-size:12px;opacity:.85;">å›ç­”é£æ ¼</label>
            <select id="style">
              <option value="concise">æ›´ç®€çŸ­</option>
              <option value="normal" selected>æ­£å¸¸</option>
              <option value="polite">æ›´ç¤¼è²Œ</option>
            </select>
          </div>

          <div class="row">
            <button id="btnSpeak" title="æœ—è¯»æœ€åä¸€æ¡å›å¤">ğŸ”Š æœ—è¯»</button>
            <button id="btnCopy" title="å¤åˆ¶æœ€åä¸€æ¡å›å¤">ğŸ“‹ å¤åˆ¶</button>
            <button id="btnClear" title="æ¸…ç©ºå¯¹è¯">ğŸ§¹ æ¸…ç©º</button>
          </div>
        </div>

        <div id="chat" class="chat"></div>

        <div style="height:10px"></div>
        <textarea id="input" placeholder="è¾“å…¥ä¸­æ–‡/ä¿„è¯­/å“ˆè¯­éƒ½å¯ä»¥ã€‚ä¾‹ï¼šæˆ‘æƒ³å»ç»¿è‰²å¸‚åœºï¼Œæ€ä¹ˆè·Ÿå¸æœºè¯´ï¼Ÿ"></textarea>
        <div class="row" style="justify-content:space-between;margin-top:10px;">
          <div style="font-size:12px;opacity:.8;">
            å°æç¤ºï¼šç¬¬ä¸€ç‰ˆä¼šé™åˆ¶æ¯å¤©æ¬¡æ•°ä¸å›ç­”é•¿åº¦ï¼Œé˜²æ­¢åˆ·çˆ†è´¹ç”¨ã€‚
          </div>
          <div class="row">
            <button id="btnSend" class="primary">å‘é€</button>
          </div>
        </div>
      </div>

      <!-- Tools -->
      <div class="card">
        <div style="font-weight:650;margin-bottom:10px;">æ—…è¡Œç”Ÿæ´»å·¥å…·ç®±ï¼ˆå“ˆè¨å…‹æ–¯å¦é€šç”¨ï¼‰</div>
        <div class="toolgrid">
          <button class="tool primary" data-prompt="æŠŠä¸‹é¢è¿™å¥è¯ç¿»è¯‘æˆ{LANG}ï¼Œå¹¶ç»™ä¸€ä¸ªæ›´ç¤¼è²Œç‰ˆæœ¬ + ä¸€ä¸ªæ›´å£è¯­ç‰ˆæœ¬ã€‚å¥å­ï¼š">ğŸ—£ï¸ ç¿»è¯‘ + ä¸¤ç§è¯­æ°”</button>
          <button class="tool primary" data-prompt="æˆ‘ç°åœ¨è¦æ‰“è½¦å»ã€ç›®çš„åœ°ã€‘ã€‚è¯·ç»™å¸æœºä¸€å¥{LANG}è¯ï¼Œå¹¶é™„ä¸Šä¸­æ–‡å¯¹ç…§ã€‚">ğŸš• æ‰“è½¦æ²Ÿé€š</button>
          <button class="tool primary" data-prompt="æˆ‘åœ¨é¤å…ç‚¹èœã€‚è¯·ç”Ÿæˆ{LANG}å¸¸ç”¨å¥ï¼šä¸è¾£/å°‘ç›/ä¸è¦é¦™èœ/è¿‡æ•/æ¸…çœŸï¼Œå¹¶é™„ä¸­æ–‡å¯¹ç…§ã€‚">ğŸ½ï¸ ç‚¹èœ&å¿Œå£</button>
          <button class="tool primary" data-prompt="æˆ‘åœ¨é…’åº—åŠç†å…¥ä½/é€€æˆ¿/å»¶è¿Ÿé€€æˆ¿ã€‚ç»™æˆ‘{LANG}å¸¸ç”¨å¥ï¼ˆé™„ä¸­æ–‡å¯¹ç…§ï¼‰ã€‚">ğŸ¨ é…’åº—æ²Ÿé€š</button>

          <button class="tool soon" data-soon="é™„è¿‘é¤å…åŠŸèƒ½æ­£åœ¨ä¸Šçº¿ä¸­ï¼ˆV2ï¼‰ã€‚ç°åœ¨å¯ä»¥ç”¨â€œç‚¹èœ&å¿Œå£â€å…ˆè§£å†³æ²Ÿé€šã€‚">ğŸ“ é™„è¿‘é¤å…ï¼ˆå³å°†ä¸Šçº¿ï¼‰</button>
          <button class="tool soon" data-soon="é…’åº—æ¨èæ­£åœ¨ä¸Šçº¿ä¸­ï¼ˆV2ï¼‰ã€‚ç°åœ¨å¯ç”¨â€œé…’åº—æ²Ÿé€šâ€è§£å†³äº¤æµã€‚">ğŸ¨ é…’åº—æ¨èï¼ˆå³å°†ä¸Šçº¿ï¼‰</button>
          <button class="tool soon" data-soon="å…¬äº¤/è·¯çº¿è§„åˆ’æ­£åœ¨ä¸Šçº¿ä¸­ï¼ˆV2ï¼‰ã€‚">ğŸšŒ å…¬äº¤è·¯çº¿ï¼ˆå³å°†ä¸Šçº¿ï¼‰</button>
          <button class="tool soon" data-soon="ç´§æ€¥æ±‚åŠ©å¡ç‰‡ï¼ˆåŒ»é™¢/è­¦å±€/æ€¥æ•‘ç”µè¯ï¼‰æ­£åœ¨ä¸Šçº¿ä¸­ï¼ˆV2ï¼‰ã€‚">ğŸ†˜ ç´§æ€¥æ±‚åŠ©ï¼ˆå³å°†ä¸Šçº¿ï¼‰</button>
        </div>

        <div style="margin-top:12px;font-size:12px;opacity:.85;line-height:1.45;">
          è¯´æ˜ï¼šè“è‰²æŒ‰é’®ä¼šç›´æ¥å¸®ä½ å‘ä¸€ä¸ªâ€œåœºæ™¯æŒ‡ä»¤â€ï¼›ç°è‰²æŒ‰é’®æ˜¯åç»­è§„åˆ’ï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä½ åœ¨æŒç»­æ›´æ–°ã€‚
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  /**********************
   *  éœ€è¦ä½ å¡«å†™çš„ä¸¤ä¸ªåç«¯
   **********************/
  const GROQ_API_BASE = 'https://rough-mountain-f0f9.almatyhelper.workers.dev'; // âœ… ä½ ç°æœ‰ Groq Worker
  const DEEPSEEK_API_BASE = ''; // âœ… ä½ éƒ¨ç½² DeepSeek åç«¯åå¡«ï¼Œä¾‹å¦‚ https://xxx.workers.dev

  // è¶…æ—¶è®¾ç½®ï¼šå›½å†…è®¿é—® Groq å¸¸å¸¸â€œå¡ä½â€ï¼Œæˆ‘ä»¬ç”¨è¶…æ—¶å¿«é€Ÿåˆ‡å¼•æ“
  const GROQ_TIMEOUT_MS = 6500;
  const DEEPSEEK_TIMEOUT_MS = 8500;

  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const btnSend = document.getElementById('btnSend');
  const btnSpeak = document.getElementById('btnSpeak');
  const btnCopy = document.getElementById('btnCopy');
  const btnClear = document.getElementById('btnClear');
  const langEl = document.getElementById('lang');
  const styleEl = document.getElementById('style');
  const toastEl = document.getElementById('toast');
  const engineBadge = document.getElementById('engineBadge');

  const state = {
    messages: [], // {role:'user'|'assistant', content:'...'}
    lastAssistant: '',
    lastEngine: 'AUTO'
  };

  function setEngineBadge(name){
    state.lastEngine = name;
    engineBadge.textContent = `å¼•æ“ï¼š${name}`;
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> toastEl.style.display='none', 2400);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  function addMsg(role, text){
    const div = document.createElement('div');
    div.className = `msg ${role === 'user' ? 'me' : 'bot'}`;
    div.innerHTML = `<div class="meta">
      <span>${role === 'user' ? 'ä½ ' : 'åŠ©æ‰‹'}</span>
      <span style="opacity:.75">${new Date().toLocaleTimeString()}</span>
    </div>${escapeHtml(text)}`;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addSystemHello(){
    addMsg('assistant',
`ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Kazakhstan Helperã€‚
ä½ å¯ä»¥ç›´æ¥è¾“å…¥ä¸­æ–‡ï¼Œæˆ‘ä¼šè¾“å‡ºä½ é€‰æ‹©çš„è¯­è¨€ï¼ˆå“ˆè¯­/ä¿„è¯­/ä¸­æ–‡ï¼‰ï¼Œå¹¶å°½é‡ç»™ä½ å¯ç›´æ¥å¤åˆ¶æˆ–æ’­æ”¾ç»™å¸æœº/å‰å°çš„å¥å­ã€‚`);
    state.lastAssistant = 'æ¬¢è¿ä½¿ç”¨ Kazakhstan Helperã€‚';
  }

  function withTimeout(promise, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=> ctrl.abort(), ms);
    return { ctrl, wrapped: (async()=> {
      try{ return await promise(ctrl.signal); }
      finally{ clearTimeout(t); }
    })()};
  }

  // å…¼å®¹ä¸åŒåç«¯è¿”å›ç»“æ„ï¼š{text} / {answer} / OpenAI-like choices
  function extractAnswer(data){
    if(!data) return '';
    if(typeof data.text === 'string') return data.text;
    if(typeof data.answer === 'string') return data.answer;
    const c = data?.choices?.[0]?.message?.content;
    if(typeof c === 'string') return c;
    const c2 = data?.choices?.[0]?.text;
    if(typeof c2 === 'string') return c2;
    return '';
  }

  async function postChat(base, timeoutMs){
    if(!base) throw new Error('åç«¯æœªé…ç½®');
    const url = `${base.replace(/\/+$/,'')}/api/chat`;

    const payload = {
      messages: state.messages,
      targetLang: langEl.value,
      style: styleEl.value
    };

    // ä½¿ç”¨ text() + JSON.parseï¼Œé¿å… 404 HTML æ—¶â€œé™é»˜â€
    const { wrapped } = withTimeout(async (signal)=>{
      const res = await fetch(url, {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify(payload),
        signal
      });

      const raw = await res.text();
      let data = {};
      try { data = JSON.parse(raw); }
      catch { data = { error: raw?.slice(0, 220) || 'Non-JSON response' }; }

      if(!res.ok){
        throw new Error(data?.error || `è¯·æ±‚å¤±è´¥ (${res.status})`);
      }
      return data;
    }, timeoutMs);

    return wrapped;
  }

  async function send(text){
    text = (text || '').trim();
    if(!text) return;

    addMsg('user', text);
    state.messages.push({role:'user', content:text});

    btnSend.disabled = true;
    btnSend.textContent = 'å‘é€ä¸­...';

    // UI å…ˆç»™ä¸€ä¸ªâ€œæ­£åœ¨å¤„ç†â€
    addMsg('assistant', 'â³ æ­£åœ¨ç”Ÿæˆâ€¦');

    // è®°å½•å ä½æ¶ˆæ¯èŠ‚ç‚¹ï¼Œåé¢æ›¿æ¢
    const placeholderNode = chatEl.lastElementChild;

    try{
      // AUTOï¼šä¼˜å…ˆ Groqï¼ˆå›½å¤–å¿«ï¼‰â†’ å¤±è´¥/è¶…æ—¶è‡ªåŠ¨åˆ‡ DeepSeekï¼ˆå›½å†…ç¨³ï¼‰
      let data = null;
      let engineUsed = 'GROQ';

      try{
        data = await postChat(GROQ_API_BASE, GROQ_TIMEOUT_MS);
        engineUsed = 'GROQ';
      }catch(e1){
        // Groq å¤±è´¥ï¼šå†è¯• DeepSeek
        if(!DEEPSEEK_API_BASE){
          throw new Error(`GROQ å¤±è´¥ï¼š${e1.message}\nï¼ˆä¸”æœªé…ç½® DEEPSEEK åç«¯ï¼‰`);
        }
        data = await postChat(DEEPSEEK_API_BASE, DEEPSEEK_TIMEOUT_MS);
        engineUsed = 'DEEPSEEK';
      }

      setEngineBadge(engineUsed);

      const answer = extractAnswer(data) || '';
      if(!answer){
        throw new Error('åç«¯è¿”å›ä¸ºç©ºï¼ˆè¯·æ£€æŸ¥æ˜¯å¦è¿”å› {text: "..."}ï¼‰');
      }

      // æ›¿æ¢å ä½æ¶ˆæ¯å†…å®¹
      placeholderNode.querySelector('.meta span:first-child').textContent = 'åŠ©æ‰‹';
      placeholderNode.querySelector('.meta span:last-child').textContent = new Date().toLocaleTimeString();
      placeholderNode.lastChild.nodeType === 3
        ? (placeholderNode.lastChild.textContent = answer)
        : (placeholderNode.innerHTML = `<div class="meta">
            <span>åŠ©æ‰‹</span>
            <span style="opacity:.75">${new Date().toLocaleTimeString()}</span>
          </div>${escapeHtml(answer)}`);

      state.messages.push({role:'assistant', content: answer});
      state.lastAssistant = answer;

    }catch(e){
      setEngineBadge('ERROR');
      const msg = e?.message || 'æœªçŸ¥é”™è¯¯';
      toast(msg);

      // å ä½æ›¿æ¢ä¸ºé”™è¯¯ä¿¡æ¯
      placeholderNode.innerHTML = `<div class="meta">
        <span>åŠ©æ‰‹</span>
        <span style="opacity:.75">${new Date().toLocaleTimeString()}</span>
      </div>${escapeHtml('ï¼ˆå‡ºé”™ï¼‰' + msg)}`;

      state.messages.push({role:'assistant', content:'ï¼ˆå‡ºé”™ï¼‰' + msg});
      state.lastAssistant = 'ï¼ˆå‡ºé”™ï¼‰' + msg;

    }finally{
      btnSend.disabled = false;
      btnSend.textContent = 'å‘é€';
      inputEl.value = '';
      inputEl.focus();
    }
  }

  // TTS
  function speak(text){
    if(!('speechSynthesis' in window)){
      toast('æµè§ˆå™¨ä¸æ”¯æŒæœ—è¯»');
      return;
    }
    if(!text) return;

    const u = new SpeechSynthesisUtterance(text);

    // è¯­è¨€ codeï¼škk / ru / zhï¼ˆå¾®ä¿¡é‡Œæœªå¿…éƒ½æœ‰å¯¹åº”å£°éŸ³ï¼‰
    const target = langEl.value === 'kk' ? 'kk-KZ' : (langEl.value === 'ru' ? 'ru-RU' : 'zh-CN');
    u.lang = target;

    const voices = speechSynthesis.getVoices?.() || [];
    // å°½é‡åŒ¹é…ï¼škk/ru/zh
    const short = (langEl.value === 'kk') ? 'kk' : (langEl.value === 'ru') ? 'ru' : 'zh';
    const v = voices.find(v => (v.lang || '').toLowerCase().startsWith(short));
    if(v) u.voice = v;

    // å¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é… voiceï¼Œæç¤ºä¸€ä¸‹ï¼ˆå°¤å…¶å“ˆè¯­ï¼‰
    if(!v && short === 'kk'){
      toast('æç¤ºï¼šä½ çš„æµè§ˆå™¨å¯èƒ½æ²¡æœ‰å“ˆè¯­è¯­éŸ³ã€‚åç»­å¯æ¥äº‘TTSæ›´ç¨³ã€‚');
    }

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  btnSend.addEventListener('click', ()=> send(inputEl.value));
  inputEl.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
      send(inputEl.value);
    }
  });

  btnSpeak.addEventListener('click', ()=>{
    if(!state.lastAssistant) return toast('è¿˜æ²¡æœ‰å¯æœ—è¯»çš„å›å¤');
    speak(state.lastAssistant);
  });

  btnCopy.addEventListener('click', async ()=>{
    if(!state.lastAssistant) return toast('è¿˜æ²¡æœ‰å¯å¤åˆ¶çš„å›å¤');
    try{
      await navigator.clipboard.writeText(state.lastAssistant);
      toast('å·²å¤åˆ¶');
    }catch{
      toast('å¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨æƒé™/å¾®ä¿¡é™åˆ¶ï¼‰');
    }
  });

  btnClear.addEventListener('click', ()=>{
    state.messages = [];
    state.lastAssistant = '';
    chatEl.innerHTML = '';
    setEngineBadge('AUTO');
    addSystemHello();
    toast('å·²æ¸…ç©º');
  });

  document.querySelectorAll('.tool.primary').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const t = btn.getAttribute('data-prompt') || '';
      const langName = (langEl.value === 'kk') ? 'å“ˆè¯­ï¼ˆKazakhï¼‰' : (langEl.value === 'ru') ? 'ä¿„è¯­ï¼ˆRussianï¼‰' : 'ä¸­æ–‡ï¼ˆChineseï¼‰';
      const prompt = t.replaceAll('{LANG}', langName);
      inputEl.value = prompt;
      inputEl.focus();
      toast('å·²å¡«å…¥åœºæ™¯æŒ‡ä»¤ï¼ˆå¯ç›´æ¥å‘é€ï¼‰');
    });
  });

  document.querySelectorAll('.tool.soon').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      toast(btn.getAttribute('data-soon') || 'å³å°†ä¸Šçº¿');
    });
  });

  // preload voices on some browsers
  window.speechSynthesis?.getVoices?.();

  // init
  setEngineBadge('AUTO');
  addSystemHello();
</script>
</body>
</html>
